#!/usr/bin/env bash

[[ -f $JOT_HOME/.env ]] && source $JOT_HOME/.env

JOT_HOME="${JOT_HOME%/}"
JOT_EDITOR=${JOT_EDITOR:-$EDITOR}
JOT_DATE_FMT=${JOT_DATE_FMT:-%Y-%m-%d}
JOT_EXT=txt

case $1 in
  e|ed|edit|'')
    shift
    cmd=edit
    ;;
  c|cat)
    shift
    cmd=cat
    ;;
  l|ls|list)
    shift
    cmd=list
    ;;
  *)
    echo "Unrecognized command: $1"
    exit 1
    ;;
esac

case $1 in
  td|today|'')
    date=$(date +$JOT_DATE_FMT)
    ;;
  y|yd|yesterday)
    date=$(date -d yesterday +$JOT_DATE_FMT)
    ;;
  tm|tommorow)
    date=$(date -d tomorrow +$JOT_DATE_FMT)
    ;;
  *)
    date=$1
    ;;
esac

echo "Today is $(date +'%a, %d %b %Y')"
echo

if [[ $cmd == 'list' ]]; then
  ls "$JOT_HOME"/*.$JOT_EXT | xargs -n 1 basename
  exit 0
fi

note_path="$JOT_HOME/$date.$JOT_EXT"

if [[ $cmd == 'cat' ]]; then
  if [[ ! -f "$note_path" ]]; then
    echo "File does not exist: $note_path"
    exit 2
  fi

  basename "$note_path" .$JOT_EXT
  echo
  cat "$note_path"
  exit 0
fi

echo "Editing $note_path"
echo
echo 'Press any key to continue'
read

if [[ -f $note_path ]]; then
  sh -c "$JOT_EDITOR $JOT_EDIT_OPTS $note_path"
else
  sh -c "$JOT_EDITOR $JOT_NEW_OPTS $note_path"
fi
