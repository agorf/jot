#!/usr/bin/env bash

[[ -f $JOT_HOME/.env ]] && source $JOT_HOME/.env

JOT_HOME="${JOT_HOME:-.}"
JOT_EDITOR=${JOT_EDITOR:-$EDITOR}
JOT_PAGER=${JOT_PAGER:-less}
JOT_DATE_FMT=${JOT_DATE_FMT:-%Y-%m-%d}
JOT_EXT=${JOT_EXT:-txt}

# Drop trailing /
JOT_HOME="${JOT_HOME%/}"

check_file_exists() {
  if [[ ! -f "$1" ]]; then
    echo "File does not exist: $1"
    exit 1
  fi
}

parse_date() {
  case $1 in
    tod|today|td|'')
      date +$JOT_DATE_FMT
      ;;
    y|yesterday|yd)
      date -d yesterday +$JOT_DATE_FMT
      ;;
    tom|tommorow|tm)
      date -d tomorrow +$JOT_DATE_FMT
      ;;
    *)
      echo $1
      ;;
  esac
}

file_from_date() {
  echo "$JOT_HOME/$1.$JOT_EXT"
}

usage() {
  cat <<-EOF
Usage: jot [command] [date]

command:

  v[iew]        view notes for a day
  e[dit]        edit notes for a day (default)
  l[ist] or ls  list notes

date:

  tod[ay]     or td  perform command for today
  y[esterday] or yd                      yesterday
  tom[orrow]  or tm                      tomorrow
  2020-04-28                             2020-04-28
EOF
}

view() {
  local date="$1"
  local file="$(file_from_date $date)"

  check_file_exists $file

  $JOT_PAGER "$file"
}

edit() {
  local date="$1"
  local file="$(file_from_date $date)"

  echo "Editing $file"
  echo
  echo 'Press any key to continue'
  read

  if [[ -f $file ]]; then
    sh -c "$JOT_EDITOR $JOT_EDIT_OPTS $file"
  else
    sh -c "$JOT_EDITOR $JOT_NEW_OPTS $file"
  fi
}

list() {
  echo "Today is $(date +'%a, %d %b %Y')"
  echo

  for file in "$JOT_HOME"/*.$JOT_EXT; do
    date=$(basename $file .$JOT_EXT)
    lines=$(wc -l $file | cut -d ' ' -f 1)
    echo -n "$date"
    printf ' (%2d)' $lines
    echo
  done
}

case $1 in
  e|edit|'')
    date="$(parse_date $2)"
    edit "$date"
    exit
    ;;
  v|view)
    date="$(parse_date $2)"
    view "$date"
    exit
    ;;
  l|list|ls)
    list
    exit
    ;;
  *)
    usage
    exit 1
    ;;
esac
